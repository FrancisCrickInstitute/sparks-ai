<html>
<head>
<title>demo.ipynb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #cf8e6d;}
.s2 { color: #bcbec4;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
demo.ipynb</font>
</center></td></tr></table>
<pre><span class="s0">#%% 
</span><span class="s1">import </span><span class="s2">matplotlib</span><span class="s3">.</span><span class="s2">pyplot </span><span class="s1">as </span><span class="s2">plt</span>
<span class="s1">import </span><span class="s2">numpy </span><span class="s1">as </span><span class="s2">np</span>
<span class="s1">import </span><span class="s2">os</span>
<span class="s1">from </span><span class="s2">scipy</span><span class="s3">.</span><span class="s2">io </span><span class="s1">import </span><span class="s2">loadmat</span>
<span class="s1">from </span><span class="s2">scipy</span><span class="s3">.</span><span class="s2">signal </span><span class="s1">import </span><span class="s2">convolve</span><span class="s3">, </span><span class="s2">correlate</span><span class="s3">, </span><span class="s2">correlation_lags</span>
<span class="s1">from </span><span class="s2">scipy</span><span class="s3">.</span><span class="s2">stats </span><span class="s1">import </span><span class="s2">norm</span>
<span class="s1">import </span><span class="s2">torch</span>
<span class="s1">from </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">nn </span><span class="s1">import </span><span class="s2">BCEWithLogitsLoss</span>
<span class="s1">import </span><span class="s2">tqdm</span>

<span class="s1">from </span><span class="s2">sparks</span><span class="s3">.</span><span class="s2">models</span><span class="s3">.</span><span class="s2">encoders </span><span class="s1">import </span><span class="s2">HebbianTransformerEncoder</span>
<span class="s1">from </span><span class="s2">sparks</span><span class="s3">.</span><span class="s2">models</span><span class="s3">.</span><span class="s2">decoders </span><span class="s1">import </span><span class="s2">mlp</span>
<span class="s1">from </span><span class="s2">sparks</span><span class="s3">.</span><span class="s2">data</span><span class="s3">.</span><span class="s2">mec</span><span class="s3">.</span><span class="s2">mec_ca </span><span class="s1">import </span><span class="s2">make_mec_ca_dataset</span>
<span class="s0">#%% md 
</span><span class="s2"># MEC slow oscillatory sequences  
</span><span class="s0">#%% md 
</span><span class="s2">`[Gonzalo Cogno, ..., Moser, Nature 2023]` have uncovered minutes-scale oscillatory sequences in the medial entorhinal cortex (MEC). 
Let's have a look at the data. 
When plotting the neurons in no particular order, their spike trains seem somewhat random. 
</span><span class="s0">#%% 
</span><span class="s2">data_path </span><span class="s3">= </span><span class="s2">os</span><span class="s3">.</span><span class="s2">path</span><span class="s3">.</span><span class="s2">join</span><span class="s3">(</span><span class="s2">os</span><span class="s3">.</span><span class="s2">getcwd</span><span class="s3">(), </span><span class="s4">'calcium_activity_matrix_60584_session17.mat'</span><span class="s3">) </span><span class="s0"># path to where the data is located.</span>
<span class="s0"># by default where the notebook is located, if the data isn't found it will be downloaded from </span>
<span class="s0"># https://github.com/soledadgcogno/Ultraslow-oscillatory-sequences/blob/main/Selection%20of%20codes/calcium_activity_matrix_60584_session17.mat</span>
<span class="s1">if not </span><span class="s2">os</span><span class="s3">.</span><span class="s2">path</span><span class="s3">.</span><span class="s2">exists</span><span class="s3">(</span><span class="s2">data_path</span><span class="s3">):</span>
    <span class="s1">import </span><span class="s2">urllib</span><span class="s3">.</span><span class="s2">request</span>
    <span class="s2">urllib</span><span class="s3">.</span><span class="s2">request</span><span class="s3">.</span><span class="s2">urlretrieve</span><span class="s3">(</span><span class="s4">&quot;https://github.com/soledadgcogno/Ultraslow-oscillatory-sequences/raw/main/Selection%20of%20codes/calcium_activity_matrix_60584_session17.mat&quot;</span><span class="s3">, </span>
                               <span class="s4">&quot;calcium_activity_matrix_60584_session17.mat&quot;</span><span class="s3">)</span>
<span class="s2">session_data </span><span class="s3">= </span><span class="s2">loadmat</span><span class="s3">(</span><span class="s2">data_path</span><span class="s3">) </span><span class="s0"># spikes saved in a matlab sparse matrix</span>
<span class="s2">spikes_idxs </span><span class="s3">= </span><span class="s2">session_data</span><span class="s3">[</span><span class="s4">'spikes_d_s'</span><span class="s3">].</span><span class="s2">nonzero</span><span class="s3">() </span><span class="s0"># obtain the spike indices </span>
<span class="s2">spikes </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">zeros</span><span class="s3">(</span><span class="s2">session_data</span><span class="s3">[</span><span class="s4">'spikes_d_s'</span><span class="s3">].</span><span class="s2">shape</span><span class="s3">) </span><span class="s0"># reconstruct the histogram</span>
<span class="s2">spikes</span><span class="s3">[</span><span class="s2">spikes_idxs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s2">spikes_idxs</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]] = </span><span class="s5">1</span>
<span class="s2">fs_120 </span><span class="s3">= </span><span class="s5">7.73 </span><span class="s0"># sampling rate</span>
<span class="s0">#%% 
</span><span class="s2">fig</span><span class="s3">, </span><span class="s2">ax </span><span class="s3">= </span><span class="s2">plt</span><span class="s3">.</span><span class="s2">subplots</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s2">figsize</span><span class="s3">=(</span><span class="s5">12</span><span class="s3">, </span><span class="s5">4</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">imshow</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">repeat</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s2">cmap</span><span class="s3">=</span><span class="s4">'Greys'</span><span class="s3">)</span>

<span class="s2">T </span><span class="s3">= </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s2">fs_120</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">), </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">T </span><span class="s3">+ </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">5</span><span class="s3">, </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">5</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xlabel</span><span class="s3">(</span><span class="s4">'Time (s)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>

<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_yticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">20 </span><span class="s3">* </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s5">20 </span><span class="s3">* </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">,</span>
                        <span class="s5">20 </span><span class="s3">* </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_yticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span>
                             <span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_ylabel</span><span class="s3">(</span><span class="s4">'Neurons'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2">However, in this work, they showed that they were able to find oscillatory sequences in the data after ordering the neurons.  
To find the correct ordering, they: 
- downsample the data 
- obtain smooth firing rates by convolving the spiking data with a gaussian kernel 
- select a random neuron and sort the other ones based on the value of the peak of the correlation 
 
The following helper functions compute all of these steps.  
</span><span class="s0">#%% 
</span><span class="s1">def </span><span class="s2">spikes_downsample</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">, </span><span class="s2">downsampling_factor</span><span class="s3">, </span><span class="s2">mode</span><span class="s3">=</span><span class="s4">'mean'</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Downsamples the spikes by binning them 
     
    Args: 
        spikes:  
        downsampling_factor:  
        mode:  
 
    Returns: 
 
    &quot;&quot;&quot;</span>
    <span class="s2">bins </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">downsampling_factor</span><span class="s3">, </span><span class="s2">downsampling_factor</span><span class="s3">)</span>
    <span class="s2">spike_times </span><span class="s3">= </span><span class="s2">spikes </span><span class="s3">* </span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">])[</span><span class="s1">None</span><span class="s3">, :]</span>
    <span class="s1">if </span><span class="s2">mode </span><span class="s3">== </span><span class="s4">'mean'</span><span class="s3">:</span>
        <span class="s1">return </span><span class="s2">np</span><span class="s3">.</span><span class="s2">vstack</span><span class="s3">([(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">histogram</span><span class="s3">(</span><span class="s2">spike_times_unit</span><span class="s3">[</span><span class="s2">spike_times_unit </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">], </span><span class="s2">bins</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">] / </span><span class="s2">downsampling_factor</span><span class="s3">)[</span><span class="s1">None</span><span class="s3">, :] </span><span class="s1">for </span><span class="s2">spike_times_unit </span><span class="s1">in </span><span class="s2">spike_times</span><span class="s3">]).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">float</span><span class="s3">)</span>
    <span class="s1">elif </span><span class="s2">mode </span><span class="s3">== </span><span class="s4">'max'</span><span class="s3">:</span>
        <span class="s1">return </span><span class="s2">np</span><span class="s3">.</span><span class="s2">vstack</span><span class="s3">([(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">histogram</span><span class="s3">(</span><span class="s2">spike_times_unit</span><span class="s3">[</span><span class="s2">spike_times_unit </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">], </span><span class="s2">bins</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">] &gt; </span><span class="s5">0</span><span class="s3">)[</span><span class="s1">None</span><span class="s3">, :] </span><span class="s1">for </span><span class="s2">spike_times_unit </span><span class="s1">in </span><span class="s2">spike_times</span><span class="s3">]).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">float</span><span class="s3">)</span>
    
<span class="s1">def </span><span class="s2">fire_rate</span><span class="s3">(</span><span class="s2">calcium_activity</span><span class="s3">, </span><span class="s2">bin_size</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Convolves the spike histogram with a Gaussian kernel to compute smooth firing rates 
     
    Args: 
        calcium_activity:  
        bin_size:  
 
    Returns: 
 
    &quot;&quot;&quot;</span>
    <span class="s0"># Define the Gaussian kernel</span>
    <span class="s2">kernel_width </span><span class="s3">= </span><span class="s5">4 </span><span class="s3">* </span><span class="s2">bin_size</span>
    <span class="s2">x </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">linspace</span><span class="s3">(-</span><span class="s2">kernel_width</span><span class="s3">, </span><span class="s2">kernel_width</span><span class="s3">, </span><span class="s2">num</span><span class="s3">=</span><span class="s5">2</span><span class="s3">*</span><span class="s2">kernel_width</span><span class="s3">, </span><span class="s2">endpoint</span><span class="s3">=</span><span class="s1">False</span><span class="s3">)</span>
    <span class="s2">gaussian_kernel </span><span class="s3">= </span><span class="s2">norm</span><span class="s3">.</span><span class="s2">pdf</span><span class="s3">(</span><span class="s2">x</span><span class="s3">, </span><span class="s2">scale</span><span class="s3">=</span><span class="s2">kernel_width</span><span class="s3">)</span>

    <span class="s0"># Normalize the kernel</span>
    <span class="s2">gaussian_kernel </span><span class="s3">/= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">sum</span><span class="s3">(</span><span class="s2">gaussian_kernel</span><span class="s3">)</span>

    <span class="s0"># Convolve the calcium activity with the Gaussian kernel</span>
    <span class="s2">smoothed_activity </span><span class="s3">= </span><span class="s2">convolve</span><span class="s3">(</span><span class="s2">calcium_activity</span><span class="s3">, </span><span class="s2">gaussian_kernel</span><span class="s3">, </span><span class="s2">mode</span><span class="s3">=</span><span class="s4">'same'</span><span class="s3">)</span>

    <span class="s1">return </span><span class="s2">smoothed_activity</span>

<span class="s1">def </span><span class="s2">sorting_xcorr</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">, </span><span class="s2">maxlag</span><span class="s3">, </span><span class="s2">downsampling_factor</span><span class="s3">, </span><span class="s2">dt_sf</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Computes correlations between the spike trains of each neurons, 
    and stores the value of the correlation at the peak. 
    Selects the neuron that has the highest peak, and sorts the other ones 
    based on their peak wrt that neuron 
     
    Args: 
        spikes:  
        maxlag:  
        downsampling_factor:  
        dt_sf:  
 
    Returns: 
 
    &quot;&quot;&quot;</span>
    <span class="s2">FRp </span><span class="s3">= </span><span class="s2">spikes_downsample</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">, </span><span class="s2">downsampling_factor</span><span class="s3">)</span>

    <span class="s2">FR </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">vstack</span><span class="s3">([</span><span class="s2">fire_rate</span><span class="s3">(</span><span class="s2">FRp</span><span class="s3">[</span><span class="s2">i</span><span class="s3">], </span><span class="s2">dt_sf</span><span class="s3">) </span><span class="s1">for </span><span class="s2">i </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">len</span><span class="s3">(</span><span class="s2">FRp</span><span class="s3">))])</span>
    <span class="s2">corr_mat </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">zeros</span><span class="s3">([</span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]])</span>

    <span class="s1">for </span><span class="s2">i </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">FR</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]):</span>
        <span class="s1">for </span><span class="s2">j </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">i</span><span class="s3">+</span><span class="s5">1</span><span class="s3">, </span><span class="s2">FR</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]):</span>
            <span class="s2">val </span><span class="s3">= </span><span class="s2">correlate</span><span class="s3">(</span><span class="s2">FR</span><span class="s3">[</span><span class="s2">i</span><span class="s3">], </span><span class="s2">FR</span><span class="s3">[</span><span class="s2">j</span><span class="s3">], </span><span class="s2">mode</span><span class="s3">=</span><span class="s4">'full'</span><span class="s3">)</span>
            <span class="s2">time </span><span class="s3">= </span><span class="s2">correlation_lags</span><span class="s3">(</span><span class="s2">len</span><span class="s3">(</span><span class="s2">FR</span><span class="s3">[</span><span class="s2">i</span><span class="s3">]), </span><span class="s2">len</span><span class="s3">(</span><span class="s2">FR</span><span class="s3">[</span><span class="s2">j</span><span class="s3">]), </span><span class="s2">mode</span><span class="s3">=</span><span class="s4">'full'</span><span class="s3">)</span>

            <span class="s2">idx </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">argmax</span><span class="s3">(</span><span class="s2">val</span><span class="s3">[</span><span class="s2">np</span><span class="s3">.</span><span class="s2">abs</span><span class="s3">(</span><span class="s2">time</span><span class="s3">) &lt; </span><span class="s2">maxlag</span><span class="s3">])</span>
            <span class="s2">v </span><span class="s3">= </span><span class="s2">val</span><span class="s3">[</span><span class="s2">np</span><span class="s3">.</span><span class="s2">abs</span><span class="s3">(</span><span class="s2">time</span><span class="s3">) &lt; </span><span class="s2">maxlag</span><span class="s3">][</span><span class="s2">idx</span><span class="s3">]</span>
            <span class="s2">t </span><span class="s3">= </span><span class="s2">time</span><span class="s3">[</span><span class="s2">np</span><span class="s3">.</span><span class="s2">abs</span><span class="s3">(</span><span class="s2">time</span><span class="s3">) &lt; </span><span class="s2">maxlag</span><span class="s3">][</span><span class="s2">idx</span><span class="s3">]</span>
    
            <span class="s1">if </span><span class="s2">t </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s2">corr_mat</span><span class="s3">[</span><span class="s2">i</span><span class="s3">, </span><span class="s2">j</span><span class="s3">] = </span><span class="s2">v</span>
                <span class="s2">corr_mat</span><span class="s3">[</span><span class="s2">j</span><span class="s3">, </span><span class="s2">i</span><span class="s3">] = -</span><span class="s2">v</span>
            <span class="s1">else</span><span class="s3">:</span>
                <span class="s2">corr_mat</span><span class="s3">[</span><span class="s2">i</span><span class="s3">, </span><span class="s2">j</span><span class="s3">] = -</span><span class="s2">v</span>
                <span class="s2">corr_mat</span><span class="s3">[</span><span class="s2">j</span><span class="s3">, </span><span class="s2">i</span><span class="s3">] = </span><span class="s2">v</span>

    <span class="s2">r</span><span class="s3">, </span><span class="s2">c </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">unravel_index</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">argmax</span><span class="s3">(</span><span class="s2">corr_mat</span><span class="s3">), </span><span class="s2">corr_mat</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">)</span>
    <span class="s1">return </span><span class="s2">np</span><span class="s3">.</span><span class="s2">argsort</span><span class="s3">(</span><span class="s2">corr_mat</span><span class="s3">[</span><span class="s2">c</span><span class="s3">])</span>

<span class="s1">def </span><span class="s2">sigmoid</span><span class="s3">(</span><span class="s2">x</span><span class="s3">):</span>
    <span class="s1">return </span><span class="s5">1 </span><span class="s3">/ (</span><span class="s5">1 </span><span class="s3">+ </span><span class="s2">np</span><span class="s3">.</span><span class="s2">exp</span><span class="s3">(-</span><span class="s2">x</span><span class="s3">))</span>

<span class="s1">def </span><span class="s2">bce_loss</span><span class="s3">(</span><span class="s2">logits</span><span class="s3">, </span><span class="s2">targets</span><span class="s3">):</span>
    <span class="s2">loss_fn </span><span class="s3">= </span><span class="s2">BCEWithLogitsLoss</span><span class="s3">()</span>
    <span class="s2">logits </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">tensor</span><span class="s3">(</span><span class="s2">logits</span><span class="s3">)</span>
    <span class="s2">targets </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">tensor</span><span class="s3">(</span><span class="s2">targets</span><span class="s3">).</span><span class="s2">unsqueeze</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">return </span><span class="s2">np</span><span class="s3">.</span><span class="s2">mean</span><span class="s3">([</span><span class="s2">loss_fn</span><span class="s3">(</span><span class="s2">logits</span><span class="s3">[..., </span><span class="s2">t</span><span class="s3">], </span><span class="s2">targets</span><span class="s3">[..., </span><span class="s2">t</span><span class="s3">]).</span><span class="s2">numpy</span><span class="s3">() </span><span class="s1">for </span><span class="s2">t </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">logits</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">])])</span>
<span class="s0">#%% md 
</span><span class="s2">Sorting neurons according to their correlation to an arbitrary neurons allows to uncover oscillations in the data! (see `[Gonzalo Cogno, ..., Moser, Nature 2023]`) 
</span><span class="s0">#%% 
</span><span class="s2">downsampling_factor </span><span class="s3">= </span><span class="s5">4</span>
<span class="s2">fs </span><span class="s3">= </span><span class="s2">fs_120 </span><span class="s3">/ </span><span class="s2">downsampling_factor</span>

<span class="s2">maxlag </span><span class="s3">= </span><span class="s5">10</span>
<span class="s2">osc_bin_size </span><span class="s3">= </span><span class="s2">int</span><span class="s3">(</span><span class="s5">12 </span><span class="s3">* </span><span class="s2">fs</span><span class="s3">)</span>
<span class="s2">sorting_corr </span><span class="s3">= </span><span class="s2">sorting_xcorr</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">, </span><span class="s2">maxlag</span><span class="s3">, </span><span class="s2">downsampling_factor</span><span class="s3">, </span><span class="s2">osc_bin_size</span><span class="s3">)</span>

<span class="s2">fig</span><span class="s3">, </span><span class="s2">ax </span><span class="s3">= </span><span class="s2">plt</span><span class="s3">.</span><span class="s2">subplots</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s2">figsize</span><span class="s3">=(</span><span class="s5">12</span><span class="s3">, </span><span class="s5">4</span><span class="s3">))</span>
<span class="s2">spikes_downsampled </span><span class="s3">= </span><span class="s2">spikes_downsample</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">, </span><span class="s2">downsampling_factor</span><span class="s3">, </span><span class="s2">mode</span><span class="s3">=</span><span class="s4">'max'</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">imshow</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">repeat</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">[</span><span class="s2">sorting_corr</span><span class="s3">], </span><span class="s5">10</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s2">cmap</span><span class="s3">=</span><span class="s4">'Greys'</span><span class="s3">)</span>

<span class="s2">T </span><span class="s3">= </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s2">fs</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">), </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">T </span><span class="s3">+ </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">5</span><span class="s3">, </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">5</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xlabel</span><span class="s3">(</span><span class="s4">'Time (s)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>

<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_yticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">10 </span><span class="s3">* </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s5">10 </span><span class="s3">* </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s5">10 </span><span class="s3">* </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_yticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_ylabel</span><span class="s3">(</span><span class="s4">'Neurons'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2">Can SPARKS be applied to this data to gain insights into it? 
</span><span class="s0">#%% md 
</span><span class="s2">## Create dataloader 
</span><span class="s0">#%% 
</span><span class="s2">start_stop_times_train </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">array</span><span class="s3">([(</span><span class="s5">600 </span><span class="s3">+ </span><span class="s2">i </span><span class="s3">* </span><span class="s5">500</span><span class="s3">, </span><span class="s5">600 </span><span class="s3">+ (</span><span class="s2">i </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">) * </span><span class="s5">500</span><span class="s3">) </span><span class="s1">for </span><span class="s2">i </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)])</span>
<span class="s2">start_stop_times_test </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">array</span><span class="s3">([[</span><span class="s5">3100</span><span class="s3">, </span><span class="s5">3600</span><span class="s3">]])</span>
<span class="s2">data_path </span><span class="s3">= </span><span class="s2">os</span><span class="s3">.</span><span class="s2">path</span><span class="s3">.</span><span class="s2">join</span><span class="s3">(</span><span class="s2">os</span><span class="s3">.</span><span class="s2">getcwd</span><span class="s3">(), </span><span class="s4">'calcium_activity_matrix_60584_session17.mat'</span><span class="s3">)</span>
<span class="s2">ds </span><span class="s3">= </span><span class="s5">4</span>

<span class="s2">train_dataset</span><span class="s3">, </span><span class="s2">train_dl </span><span class="s3">= </span><span class="s2">make_mec_ca_dataset</span><span class="s3">(</span><span class="s2">data_path</span><span class="s3">,</span>
                                              <span class="s2">start_stop_times</span><span class="s3">=</span><span class="s2">start_stop_times_train</span><span class="s3">,</span>
                                              <span class="s2">downsampling_factor</span><span class="s3">=</span><span class="s2">ds</span><span class="s3">,</span>
                                              <span class="s2">batch_size</span><span class="s3">=</span><span class="s5">5</span><span class="s3">,</span>
                                              <span class="s2">train</span><span class="s3">=</span><span class="s1">True</span><span class="s3">)</span>

<span class="s2">test_dataset</span><span class="s3">, </span><span class="s2">test_dl </span><span class="s3">= </span><span class="s2">make_mec_ca_dataset</span><span class="s3">(</span><span class="s2">data_path</span><span class="s3">,</span>
                                            <span class="s2">start_stop_times</span><span class="s3">=</span><span class="s2">start_stop_times_test</span><span class="s3">,</span>
                                            <span class="s2">downsampling_factor</span><span class="s3">=</span><span class="s2">ds</span><span class="s3">,</span>
                                            <span class="s2">batch_size</span><span class="s3">=</span><span class="s5">5</span><span class="s3">,</span>
                                            <span class="s2">train</span><span class="s3">=</span><span class="s1">False</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2">## Initialise model 
</span><span class="s0">#%% 
</span><span class="s2">embed_dim </span><span class="s3">= </span><span class="s5">128  </span><span class="s0"># attention embedding dimension</span>
<span class="s2">latent_dim </span><span class="s3">= </span><span class="s5">64  </span><span class="s0"># latent dimension</span>
<span class="s2">tau_s </span><span class="s3">= </span><span class="s5">100  </span><span class="s0"># STDP decay period (in seconds)</span>
<span class="s2">tau_p </span><span class="s3">= </span><span class="s5">1  </span><span class="s0"># past time-steps window</span>
<span class="s2">tau_f </span><span class="s3">= </span><span class="s5">1  </span><span class="s0"># future time-steps window</span>
<span class="s2">n_layers </span><span class="s3">= </span><span class="s5">0  </span><span class="s0"># number of conventional attention layers</span>
<span class="s2">n_heads </span><span class="s3">= </span><span class="s5">1  </span><span class="s0"># number of attention heads</span>
<span class="s2">input_size </span><span class="s3">= </span><span class="s2">len</span><span class="s3">(</span><span class="s2">train_dataset</span><span class="s3">.</span><span class="s2">spikes</span><span class="s3">)</span>
<span class="s2">beta </span><span class="s3">= </span><span class="s5">0.001  </span><span class="s0"># KDL regularisation strength</span>

<span class="s0"># if a gpu is available</span>
<span class="s1">if </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">cuda</span><span class="s3">.</span><span class="s2">is_available</span><span class="s3">():</span>
    <span class="s2">device </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">device</span><span class="s3">(</span><span class="s4">'cuda'</span><span class="s3">)</span>
<span class="s0"># If on a recent macbook</span>
<span class="s1">elif </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">backends</span><span class="s3">.</span><span class="s2">mps</span><span class="s3">.</span><span class="s2">is_available</span><span class="s3">():</span>
    <span class="s2">device </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">device</span><span class="s3">(</span><span class="s4">'mps:0'</span><span class="s3">)</span>
<span class="s1">else</span><span class="s3">:</span>
    <span class="s2">device </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">device</span><span class="s3">(</span><span class="s4">'cpu'</span><span class="s3">)</span>

<span class="s2">encoding_network </span><span class="s3">= </span><span class="s2">HebbianTransformerEncoder</span><span class="s3">(</span><span class="s2">n_neurons_per_sess</span><span class="s3">=</span><span class="s2">input_size</span><span class="s3">,</span>
                                             <span class="s2">embed_dim</span><span class="s3">=</span><span class="s2">embed_dim</span><span class="s3">,</span>
                                             <span class="s2">latent_dim</span><span class="s3">=</span><span class="s2">latent_dim</span><span class="s3">,</span>
                                             <span class="s2">tau_s_per_sess</span><span class="s3">=</span><span class="s2">tau_s</span><span class="s3">,</span>
                                             <span class="s2">dt_per_sess</span><span class="s3">=</span><span class="s2">ds </span><span class="s3">/ </span><span class="s5">7.73</span><span class="s3">,</span>
                                             <span class="s2">n_layers</span><span class="s3">=</span><span class="s2">n_layers</span><span class="s3">,</span>
                                             <span class="s2">n_heads</span><span class="s3">=</span><span class="s2">n_heads</span><span class="s3">).</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">)</span>
<span class="s2">n_inputs_decoder </span><span class="s3">= </span><span class="s2">latent_dim </span><span class="s3">* </span><span class="s2">tau_p</span>
<span class="s2">decoding_network </span><span class="s3">= </span><span class="s2">mlp</span><span class="s3">(</span><span class="s2">in_dim</span><span class="s3">=</span><span class="s2">n_inputs_decoder</span><span class="s3">,</span>
                       <span class="s2">hid_features</span><span class="s3">=</span><span class="s2">int</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">mean</span><span class="s3">([</span><span class="s2">n_inputs_decoder</span><span class="s3">, </span><span class="s2">input_size</span><span class="s3">])),</span>
                       <span class="s2">output_dim_per_session</span><span class="s3">=</span><span class="s2">input_size</span><span class="s3">).</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">)</span>

<span class="s2">lr </span><span class="s3">= </span><span class="s5">0.001</span>
<span class="s2">optimizer </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">optim</span><span class="s3">.</span><span class="s2">Adam</span><span class="s3">(</span><span class="s2">list</span><span class="s3">(</span><span class="s2">encoding_network</span><span class="s3">.</span><span class="s2">parameters</span><span class="s3">())</span>
                             <span class="s3">+ </span><span class="s2">list</span><span class="s3">(</span><span class="s2">decoding_network</span><span class="s3">.</span><span class="s2">parameters</span><span class="s3">()), </span><span class="s2">lr</span><span class="s3">=</span><span class="s2">lr</span><span class="s3">)</span>
<span class="s2">scheduler </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">optim</span><span class="s3">.</span><span class="s2">lr_scheduler</span><span class="s3">.</span><span class="s2">StepLR</span><span class="s3">(</span><span class="s2">optimizer</span><span class="s3">, </span><span class="s2">step_size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s2">gamma</span><span class="s3">=</span><span class="s5">0.5</span><span class="s3">)</span>
<span class="s2">loss_fn </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">nn</span><span class="s3">.</span><span class="s2">BCEWithLogitsLoss</span><span class="s3">()</span>
<span class="s0">#%% md 
</span><span class="s2">## Training and testing 
 
Training is as simple as running the following loop  
</span><span class="s0">#%% 
</span><span class="s1">from </span><span class="s2">sparks</span><span class="s3">.</span><span class="s2">utils</span><span class="s3">.</span><span class="s2">train </span><span class="s1">import </span><span class="s2">train</span>
<span class="s1">from </span><span class="s2">sparks</span><span class="s3">.</span><span class="s2">utils</span><span class="s3">.</span><span class="s2">test </span><span class="s1">import </span><span class="s2">test</span>

<span class="s2">test_period </span><span class="s3">= </span><span class="s5">1</span>
<span class="s2">n_epochs </span><span class="s3">= </span><span class="s5">1  </span><span class="s0"># Number of training epochs</span>

<span class="s1">for </span><span class="s2">epoch </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">n_epochs</span><span class="s3">):</span>
    <span class="s2">train</span><span class="s3">(</span><span class="s2">encoder</span><span class="s3">=</span><span class="s2">encoding_network</span><span class="s3">,</span>
          <span class="s2">decoder</span><span class="s3">=</span><span class="s2">decoding_network</span><span class="s3">,</span>
          <span class="s2">train_dls</span><span class="s3">=[</span><span class="s2">train_dl</span><span class="s3">],</span>
          <span class="s2">loss_fn</span><span class="s3">=</span><span class="s2">loss_fn</span><span class="s3">,</span>
          <span class="s2">optimizer</span><span class="s3">=</span><span class="s2">optimizer</span><span class="s3">,</span>
          <span class="s2">latent_dim</span><span class="s3">=</span><span class="s2">latent_dim</span><span class="s3">,</span>
          <span class="s2">tau_p</span><span class="s3">=</span><span class="s2">tau_p</span><span class="s3">,</span>
          <span class="s2">tau_f</span><span class="s3">=</span><span class="s2">tau_f</span><span class="s3">,</span>
          <span class="s2">beta</span><span class="s3">=</span><span class="s2">beta</span><span class="s3">,</span>
          <span class="s2">device</span><span class="s3">=</span><span class="s2">device</span><span class="s3">)</span>
    <span class="s2">scheduler</span><span class="s3">.</span><span class="s2">step</span><span class="s3">()</span>

    <span class="s1">if </span><span class="s3">(</span><span class="s2">epoch </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">) % </span><span class="s2">test_period </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
        <span class="s2">test_loss</span><span class="s3">, </span><span class="s2">encoder_outputs</span><span class="s3">, </span><span class="s2">decoder_outputs </span><span class="s3">= </span><span class="s2">test</span><span class="s3">(</span><span class="s2">encoder</span><span class="s3">=</span><span class="s2">encoding_network</span><span class="s3">,</span>
                                                           <span class="s2">decoder</span><span class="s3">=</span><span class="s2">decoding_network</span><span class="s3">,</span>
                                                           <span class="s2">test_dls</span><span class="s3">=[</span><span class="s2">test_dl</span><span class="s3">],</span>
                                                           <span class="s2">latent_dim</span><span class="s3">=</span><span class="s2">latent_dim</span><span class="s3">,</span>
                                                           <span class="s2">tau_p</span><span class="s3">=</span><span class="s2">tau_p</span><span class="s3">,</span>
                                                           <span class="s2">tau_f</span><span class="s3">=</span><span class="s2">tau_f</span><span class="s3">,</span>
                                                           <span class="s2">loss_fn</span><span class="s3">=</span><span class="s2">loss_fn</span><span class="s3">,</span>
                                                           <span class="s2">device</span><span class="s3">=</span><span class="s2">device</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2">Let's have a look at what happens behind the scene... This is what the training and test loops look like.  
</span><span class="s0">#%% 
</span><span class="s1">for </span><span class="s2">epoch </span><span class="s1">in </span><span class="s2">tqdm</span><span class="s3">.</span><span class="s2">tqdm</span><span class="s3">(</span><span class="s2">range</span><span class="s3">(</span><span class="s2">n_epochs</span><span class="s3">)):</span>
    <span class="s2">train_iterator </span><span class="s3">= </span><span class="s2">iter</span><span class="s3">(</span><span class="s2">train_dl</span><span class="s3">)</span>
    <span class="s2">decoding_network</span><span class="s3">.</span><span class="s2">train</span><span class="s3">()</span>
    <span class="s2">encoding_network</span><span class="s3">.</span><span class="s2">train</span><span class="s3">()</span>

    <span class="s1">for </span><span class="s2">inputs</span><span class="s3">, </span><span class="s2">_ </span><span class="s1">in </span><span class="s2">train_iterator</span><span class="s3">:</span>
        <span class="s0">### Initialize training for a batch</span>
        <span class="s2">inputs </span><span class="s3">= </span><span class="s2">inputs</span><span class="s3">.</span><span class="s2">float</span><span class="s3">()</span>
        <span class="s2">T </span><span class="s3">= </span><span class="s2">inputs</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]   </span><span class="s0"># Number of time-steps in the recording</span>
        <span class="s2">encoding_network</span><span class="s3">.</span><span class="s2">zero_</span><span class="s3">()  </span><span class="s0"># Resets the attention layer</span>
        
        <span class="s0"># Initialize the outputs of the encoder as zeroes to match the input dimension of the decoder in the first time-steps</span>
        <span class="s2">encoder_outputs </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">zeros</span><span class="s3">([</span><span class="s2">len</span><span class="s3">(</span><span class="s2">inputs</span><span class="s3">), </span><span class="s2">latent_dim</span><span class="s3">, </span><span class="s2">tau_p</span><span class="s3">]).</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">)</span>
        <span class="s2">loss </span><span class="s3">= </span><span class="s5">0</span>

        <span class="s1">for </span><span class="s2">t </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">T </span><span class="s3">- </span><span class="s2">tau_f </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">):</span>
            <span class="s2">mu</span><span class="s3">, </span><span class="s2">logvar </span><span class="s3">= </span><span class="s2">encoding_network</span><span class="s3">(</span><span class="s2">inputs</span><span class="s3">[..., </span><span class="s2">t</span><span class="s3">].</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">))  </span><span class="s0"># Obtain the mean and std for the reparametrisation trick</span>
            <span class="s2">encoder_outputs </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">cat</span><span class="s3">((</span><span class="s2">encoder_outputs</span><span class="s3">, </span>
                                         <span class="s2">encoding_network</span><span class="s3">.</span><span class="s2">reparametrize</span><span class="s3">(</span><span class="s2">mu</span><span class="s3">, </span><span class="s2">logvar</span><span class="s3">).</span><span class="s2">unsqueeze</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)), </span><span class="s2">dim</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">) </span><span class="s0"># apply the reparametrisation trick and save the results</span>
            <span class="s2">decoder_outputs </span><span class="s3">= </span><span class="s2">decoding_network</span><span class="s3">(</span><span class="s2">encoder_outputs</span><span class="s3">[..., -</span><span class="s2">tau_p</span><span class="s3">:].</span><span class="s2">reshape</span><span class="s3">(</span><span class="s2">len</span><span class="s3">(</span><span class="s2">encoder_outputs</span><span class="s3">), -</span><span class="s5">1</span><span class="s3">))  </span><span class="s0"># Obtain decoder outputs</span>

            <span class="s2">loss </span><span class="s3">+= (</span><span class="s2">loss_fn</span><span class="s3">(</span><span class="s2">decoder_outputs</span><span class="s3">,</span>
                            <span class="s2">inputs</span><span class="s3">[..., </span><span class="s2">t</span><span class="s3">:</span><span class="s2">t </span><span class="s3">+ </span><span class="s2">tau_f</span><span class="s3">].</span><span class="s2">reshape</span><span class="s3">(</span><span class="s2">inputs</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], -</span><span class="s5">1</span><span class="s3">).</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">)) </span>
                     <span class="s3">- </span><span class="s2">beta </span><span class="s3">* </span><span class="s5">0.5 </span><span class="s3">* </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">mean</span><span class="s3">(</span><span class="s5">1 </span><span class="s3">+ </span><span class="s2">logvar </span><span class="s3">- </span><span class="s2">mu</span><span class="s3">.</span><span class="s2">pow</span><span class="s3">(</span><span class="s5">2</span><span class="s3">) - </span><span class="s2">logvar</span><span class="s3">.</span><span class="s2">exp</span><span class="s3">())) </span><span class="s0"># Compute the current loss</span>

        <span class="s0"># Apply SGD at the end of the presentation of the batch ('batch training')</span>
        <span class="s2">loss</span><span class="s3">.</span><span class="s2">backward</span><span class="s3">()</span>
        <span class="s2">optimizer</span><span class="s3">.</span><span class="s2">step</span><span class="s3">()</span>
        <span class="s2">encoding_network</span><span class="s3">.</span><span class="s2">zero_grad</span><span class="s3">()</span>
        <span class="s2">decoding_network</span><span class="s3">.</span><span class="s2">zero_grad</span><span class="s3">()</span>
<span class="s0">#%% md 
</span><span class="s2">### Testing loop 
</span><span class="s0">#%% 
</span><span class="s1">with </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">no_grad</span><span class="s3">():</span>
    <span class="s2">test_iterator </span><span class="s3">= </span><span class="s2">iter</span><span class="s3">(</span><span class="s2">test_dl</span><span class="s3">)</span>
    <span class="s2">decoding_network</span><span class="s3">.</span><span class="s2">eval</span><span class="s3">()</span>
    <span class="s2">encoding_network</span><span class="s3">.</span><span class="s2">eval</span><span class="s3">()</span>

    <span class="s2">encoder_outputs </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">Tensor</span><span class="s3">().</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">)</span>
    <span class="s2">decoder_outputs </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">Tensor</span><span class="s3">().</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">)</span>
    <span class="s2">test_targets </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">Tensor</span><span class="s3">()</span>
    <span class="s2">test_loss </span><span class="s3">= </span><span class="s5">0</span>

    <span class="s1">for </span><span class="s2">inputs</span><span class="s3">, </span><span class="s2">_ </span><span class="s1">in </span><span class="s2">tqdm</span><span class="s3">.</span><span class="s2">tqdm</span><span class="s3">(</span><span class="s2">test_iterator</span><span class="s3">):</span>
        <span class="s2">inputs </span><span class="s3">= </span><span class="s2">inputs</span><span class="s3">.</span><span class="s2">float</span><span class="s3">()</span>
        <span class="s2">T </span><span class="s3">= </span><span class="s2">inputs</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">encoding_network</span><span class="s3">.</span><span class="s2">zero_</span><span class="s3">()</span>
        <span class="s2">encoder_outputs_batch </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">zeros</span><span class="s3">([</span><span class="s2">len</span><span class="s3">(</span><span class="s2">inputs</span><span class="s3">), </span><span class="s2">tau_p</span><span class="s3">, </span><span class="s2">latent_dim</span><span class="s3">]).</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">)</span>
        <span class="s2">decoder_outputs_batch </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">Tensor</span><span class="s3">().</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">)</span>

        <span class="s1">for </span><span class="s2">t </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">T </span><span class="s3">- </span><span class="s2">tau_f </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">):</span>
            <span class="s2">mu</span><span class="s3">, </span><span class="s2">logvar </span><span class="s3">= </span><span class="s2">encoding_network</span><span class="s3">(</span><span class="s2">inputs</span><span class="s3">[..., </span><span class="s2">t</span><span class="s3">].</span><span class="s2">to</span><span class="s3">(</span><span class="s2">device</span><span class="s3">))</span>
            <span class="s2">encoder_outputs_batch </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">cat</span><span class="s3">((</span><span class="s2">encoder_outputs_batch</span><span class="s3">,</span>
                                               <span class="s2">encoding_network</span><span class="s3">.</span><span class="s2">reparametrize</span><span class="s3">(</span><span class="s2">mu</span><span class="s3">, </span><span class="s2">logvar</span><span class="s3">).</span><span class="s2">unsqueeze</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)), </span><span class="s2">dim</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">dec_outputs </span><span class="s3">= </span><span class="s2">decoding_network</span><span class="s3">(</span><span class="s2">encoder_outputs_batch</span><span class="s3">[:, -</span><span class="s2">tau_p</span><span class="s3">:])</span>

            <span class="s2">decoder_outputs_batch </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">cat</span><span class="s3">((</span><span class="s2">decoder_outputs_batch</span><span class="s3">,</span>
                                               <span class="s2">dec_outputs</span><span class="s3">.</span><span class="s2">unsqueeze</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)), </span><span class="s2">dim</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s2">encoder_outputs </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">cat</span><span class="s3">((</span><span class="s2">encoder_outputs</span><span class="s3">, </span><span class="s2">encoder_outputs_batch</span><span class="s3">), </span><span class="s2">dim</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s2">decoder_outputs </span><span class="s3">= </span><span class="s2">torch</span><span class="s3">.</span><span class="s2">cat</span><span class="s3">((</span><span class="s2">decoder_outputs</span><span class="s3">, </span><span class="s2">decoder_outputs_batch</span><span class="s3">), </span><span class="s2">dim</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2"># Looking at the results 
</span><span class="s0">#%% md 
</span><span class="s2">Training on this example is not too long (~35s/epoch on a Macbook Pro M2 Max), but you may not want to wait for 100s of epochs to see the results. There are a few pre-trained models and their outputs in the examples/ folder.  
</span><span class="s0">#%% md 
</span><span class="s2">This first figure shows the results obtained to predict 500s of recording that were left out from the training data. 
We trained two models, one implementing SPARKS, and the second implementing an alternative attention rule relying on symmetric STDP. 
As you can see, both reach similar accuracy, but only SPARKS is able to recover the oscillatory sequences.  
</span><span class="s0">#%% 
</span><span class="s2">fig</span><span class="s3">, </span><span class="s2">ax </span><span class="s3">= </span><span class="s2">plt</span><span class="s3">.</span><span class="s2">subplots</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s2">figsize</span><span class="s3">=(</span><span class="s5">25</span><span class="s3">, </span><span class="s5">12</span><span class="s3">))</span>

<span class="s2">res_path </span><span class="s3">= </span><span class="s2">os</span><span class="s3">.</span><span class="s2">path</span><span class="s3">.</span><span class="s2">join</span><span class="s3">(</span><span class="s2">os</span><span class="s3">.</span><span class="s2">getcwd</span><span class="s3">(), </span><span class="s4">'examples/mec_prediction_ca_example'</span><span class="s3">)</span>
<span class="s2">preds </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">load</span><span class="s3">(</span><span class="s2">os</span><span class="s3">.</span><span class="s2">path</span><span class="s3">.</span><span class="s2">join</span><span class="s3">(</span><span class="s2">res_path</span><span class="s3">, </span><span class="s4">'dec_outputs_best.npy'</span><span class="s3">))</span>

<span class="s2">start_stop_times_test </span><span class="s3">= [</span><span class="s5">3100</span><span class="s3">, </span><span class="s5">3600</span><span class="s3">]</span>
<span class="s2">spikes_test </span><span class="s3">= </span><span class="s2">spikes_downsampled</span><span class="s3">[</span><span class="s2">sorting_corr</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">start_stop_times_test</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] * </span><span class="s2">fs</span><span class="s3">):</span><span class="s2">int</span><span class="s3">(</span><span class="s2">start_stop_times_test </span><span class="s3">[</span><span class="s5">1</span><span class="s3">] * </span><span class="s2">fs</span><span class="s3">)]</span>
<span class="s2">T </span><span class="s3">= </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s2">fs</span>

<span class="s2">ax</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">imshow</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">repeat</span><span class="s3">(</span><span class="s2">spikes_test</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s2">cmap</span><span class="s3">=</span><span class="s4">'Greys'</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">set_title</span><span class="s3">(</span><span class="s4">'Example sequence'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">, </span><span class="s2">pad</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">grid</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">), </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">set_xticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">T </span><span class="s3">+ </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">, </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">set_xlabel</span><span class="s3">(</span><span class="s4">'Time (s)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>

<span class="s2">ax</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">set_yticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">set_yticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">set_ylabel</span><span class="s3">(</span><span class="s4">'Neurons'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>

<span class="s2">ax</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">imshow</span><span class="s3">(</span><span class="s2">sigmoid</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">repeat</span><span class="s3">(</span><span class="s2">preds</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)), </span><span class="s2">cmap</span><span class="s3">=</span><span class="s4">'Greys'</span><span class="s3">, </span><span class="s2">vmin</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s2">vmax</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">grid</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">), </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">), </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">set_xticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">T </span><span class="s3">+ </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">, </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">set_yticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">set_yticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">set_title</span><span class="s3">(</span><span class="s4">'STDP </span><span class="s1">\n </span><span class="s4">BCE: %.3f, osc. score: 1.' </span><span class="s3">% </span><span class="s2">bce_loss</span><span class="s3">(</span><span class="s2">preds</span><span class="s3">, </span><span class="s2">spikes_test</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">, </span><span class="s2">pad</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">set_xlabel</span><span class="s3">(</span><span class="s4">'Time (s)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>

<span class="s2">res_path </span><span class="s3">= </span><span class="s2">os</span><span class="s3">.</span><span class="s2">path</span><span class="s3">.</span><span class="s2">join</span><span class="s3">(</span><span class="s2">os</span><span class="s3">.</span><span class="s2">getcwd</span><span class="s3">(), </span><span class="s4">'examples/mec_prediction_ca_symm_example'</span><span class="s3">)</span>
<span class="s2">preds_symm </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">load</span><span class="s3">(</span><span class="s2">os</span><span class="s3">.</span><span class="s2">path</span><span class="s3">.</span><span class="s2">join</span><span class="s3">(</span><span class="s2">res_path</span><span class="s3">, </span><span class="s4">'dec_outputs_best.npy'</span><span class="s3">))</span>
<span class="s2">a </span><span class="s3">= </span><span class="s2">ax</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s2">imshow</span><span class="s3">(</span><span class="s2">sigmoid</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">repeat</span><span class="s3">(</span><span class="s2">preds_symm</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)), </span><span class="s2">cmap</span><span class="s3">=</span><span class="s4">'Greys'</span><span class="s3">, </span><span class="s2">vmin</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s2">vmax</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s2">grid</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">), </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">), </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s2">set_xticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">T </span><span class="s3">+ </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">, </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s2">set_yticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s2">set_yticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s2">spikes_test</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s2">set_title</span><span class="s3">(</span><span class="s4">'Symm. rule </span><span class="s1">\n </span><span class="s4">BCE: %.3f, osc. score: 0.' </span><span class="s3">% </span><span class="s2">bce_loss</span><span class="s3">(</span><span class="s2">preds_symm</span><span class="s3">, </span><span class="s2">spikes_test</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">, </span><span class="s2">pad</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">[</span><span class="s5">2</span><span class="s3">].</span><span class="s2">set_xlabel</span><span class="s3">(</span><span class="s4">'Time (s)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>

<span class="s2">cb_ax </span><span class="s3">= </span><span class="s2">fig</span><span class="s3">.</span><span class="s2">add_axes</span><span class="s3">([</span><span class="s5">0.95</span><span class="s3">, </span><span class="s5">0.15</span><span class="s3">, </span><span class="s5">0.02</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">])</span>
<span class="s2">cbar </span><span class="s3">= </span><span class="s2">fig</span><span class="s3">.</span><span class="s2">colorbar</span><span class="s3">(</span><span class="s2">a</span><span class="s3">, </span><span class="s2">cax</span><span class="s3">=</span><span class="s2">cb_ax</span><span class="s3">)</span>
<span class="s2">cbar</span><span class="s3">.</span><span class="s2">ax</span><span class="s3">.</span><span class="s2">tick_params</span><span class="s3">(</span><span class="s2">labelsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s2">cbar</span><span class="s3">.</span><span class="s2">ax</span><span class="s3">.</span><span class="s2">set_ylabel</span><span class="s3">(</span><span class="s4">'Spike probability'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">, </span><span class="s2">labelpad</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2"># What insights can we get from unsupervised learning? 
</span><span class="s0">#%% md 
</span><span class="s2">Next, we investigate the insights we can gain from unsupervised learning with SPARKS. 
To do so, we first plot the 2-dimensional latent embeddings obtained with our method. 
</span><span class="s0">#%% 
</span><span class="s2">fig</span><span class="s3">, </span><span class="s2">ax </span><span class="s3">= </span><span class="s2">plt</span><span class="s3">.</span><span class="s2">subplots</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s2">figsize</span><span class="s3">=(</span><span class="s5">15</span><span class="s3">, </span><span class="s5">15</span><span class="s3">))</span>

<span class="s2">res_path </span><span class="s3">= </span><span class="s2">os</span><span class="s3">.</span><span class="s2">path</span><span class="s3">.</span><span class="s2">join</span><span class="s3">(</span><span class="s2">os</span><span class="s3">.</span><span class="s2">getcwd</span><span class="s3">(), </span><span class="s4">'examples/mec_unsupervised_ca'</span><span class="s3">)</span>
<span class="s2">tau_p </span><span class="s3">= </span><span class="s5">30</span>

<span class="s2">encodings </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">load</span><span class="s3">(</span><span class="s2">os</span><span class="s3">.</span><span class="s2">path</span><span class="s3">.</span><span class="s2">join</span><span class="s3">(</span><span class="s2">res_path</span><span class="s3">, </span><span class="s4">'enc_outputs_best.npy'</span><span class="s3">))[</span><span class="s5">0</span><span class="s3">, :, </span><span class="s2">tau_p</span><span class="s3">:]</span>

<span class="s2">a </span><span class="s3">= </span><span class="s2">ax</span><span class="s3">.</span><span class="s2">scatter</span><span class="s3">(</span><span class="s2">encodings</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s2">encodings</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s2">cmap </span><span class="s3">= </span><span class="s4">'magma'</span><span class="s3">, </span><span class="s2">c</span><span class="s3">=</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s2">encodings</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">])/</span><span class="s2">fs</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">grid</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>

<span class="s2">cbar </span><span class="s3">= </span><span class="s2">plt</span><span class="s3">.</span><span class="s2">colorbar</span><span class="s3">(</span><span class="s2">a</span><span class="s3">, </span><span class="s2">ax</span><span class="s3">=</span><span class="s2">ax</span><span class="s3">, </span><span class="s2">shrink</span><span class="s3">=</span><span class="s5">0.75</span><span class="s3">)</span>
<span class="s2">cbar</span><span class="s3">.</span><span class="s2">ax</span><span class="s3">.</span><span class="s2">tick_params</span><span class="s3">(</span><span class="s2">labelsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">) </span>
<span class="s2">cbar</span><span class="s3">.</span><span class="s2">ax</span><span class="s3">.</span><span class="s2">set_ylabel</span><span class="s3">(</span><span class="s4">'Time (s)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">, </span><span class="s2">labelpad</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>

<span class="s2">ax</span><span class="s3">.</span><span class="s2">tick_params</span><span class="s3">(</span><span class="s2">axis</span><span class="s3">=</span><span class="s4">'both'</span><span class="s3">, </span><span class="s2">which</span><span class="s3">=</span><span class="s4">'major'</span><span class="s3">, </span><span class="s2">labelsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xlabel</span><span class="s3">(</span><span class="s4">'neural axis 1'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">30</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_ylabel</span><span class="s3">(</span><span class="s4">'neural axis 2'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">30</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">'right'</span><span class="s3">].</span><span class="s2">set_visible</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">'top'</span><span class="s3">].</span><span class="s2">set_visible</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">'left'</span><span class="s3">].</span><span class="s2">set_visible</span><span class="s3">(</span><span class="s1">True</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">'bottom'</span><span class="s3">].</span><span class="s2">set_visible</span><span class="s3">(</span><span class="s1">True</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">&quot;left&quot;</span><span class="s3">].</span><span class="s2">set_color</span><span class="s3">(</span><span class="s4">'grey'</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">&quot;bottom&quot;</span><span class="s3">].</span><span class="s2">set_color</span><span class="s3">(</span><span class="s4">'grey'</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">&quot;left&quot;</span><span class="s3">].</span><span class="s2">set_linewidth</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">&quot;bottom&quot;</span><span class="s3">].</span><span class="s2">set_linewidth</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2">As you may notice, the latent embeddings seem to follow a ring topology that shifts over time. 
Can we recover the phase of the oscillations from this representation?  
To try and do so, we obtain the current centre of the ring as the average position of the embeddings over the last ~50s, which is relevant to the time-scale of the oscillations. 
Then, we compute the angle between a segment that connects the centre of the ring to the current embedding, and a horizontal segment starting from the current embedding. 
The functions below do all of these things.  
</span><span class="s0">#%% 
</span><span class="s1">import </span><span class="s2">math</span>

<span class="s1">def </span><span class="s2">calculate_angle</span><span class="s3">(</span><span class="s2">segment1</span><span class="s3">, </span><span class="s2">segment2</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Calculate the angle in degrees between two segments 
    Args: 
        segment1:  
        segment2:  
 
    Returns: 
 
    &quot;&quot;&quot;</span>
    <span class="s0"># Convert the segments into vectors</span>
    <span class="s2">vec1 </span><span class="s3">= (</span><span class="s2">segment1</span><span class="s3">[</span><span class="s5">1</span><span class="s3">][</span><span class="s5">0</span><span class="s3">] - </span><span class="s2">segment1</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s5">0</span><span class="s3">], </span><span class="s2">segment1</span><span class="s3">[</span><span class="s5">1</span><span class="s3">][</span><span class="s5">1</span><span class="s3">] - </span><span class="s2">segment1</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">vec2 </span><span class="s3">= (</span><span class="s2">segment2</span><span class="s3">[</span><span class="s5">1</span><span class="s3">][</span><span class="s5">0</span><span class="s3">] - </span><span class="s2">segment2</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s5">0</span><span class="s3">], </span><span class="s2">segment2</span><span class="s3">[</span><span class="s5">1</span><span class="s3">][</span><span class="s5">1</span><span class="s3">] - </span><span class="s2">segment2</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s0"># Calculate the dot product</span>
    <span class="s2">dot_product </span><span class="s3">= </span><span class="s2">vec1</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] * </span><span class="s2">vec2</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s2">vec1</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] * </span><span class="s2">vec2</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>

    <span class="s0"># Calculate the magnitudes of the vectors</span>
    <span class="s2">mag_vec1 </span><span class="s3">= </span><span class="s2">math</span><span class="s3">.</span><span class="s2">sqrt</span><span class="s3">(</span><span class="s2">vec1</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]**</span><span class="s5">2 </span><span class="s3">+ </span><span class="s2">vec1</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]**</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s2">mag_vec2 </span><span class="s3">= </span><span class="s2">math</span><span class="s3">.</span><span class="s2">sqrt</span><span class="s3">(</span><span class="s2">vec2</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]**</span><span class="s5">2 </span><span class="s3">+ </span><span class="s2">vec2</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]**</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s0"># Calculate the cosine of the angle using the dot product and the magnitudes</span>
    <span class="s2">cos_angle </span><span class="s3">= </span><span class="s2">dot_product </span><span class="s3">/ (</span><span class="s2">mag_vec1 </span><span class="s3">* </span><span class="s2">mag_vec2</span><span class="s3">)</span>

    <span class="s0"># Use the arccos function to find the angle in radians, then convert it to degrees</span>
    <span class="s2">angle </span><span class="s3">= </span><span class="s2">math</span><span class="s3">.</span><span class="s2">degrees</span><span class="s3">(</span><span class="s2">math</span><span class="s3">.</span><span class="s2">acos</span><span class="s3">(</span><span class="s2">cos_angle</span><span class="s3">))</span>
    
    <span class="s1">return </span><span class="s2">angle</span>

<span class="s2">phi_t </span><span class="s3">= []</span>
<span class="s2">window </span><span class="s3">= </span><span class="s5">100 </span><span class="s0"># window to find the centre of the circle</span>
<span class="s2">tau_p </span><span class="s3">= </span><span class="s5">30</span>

<span class="s1">for </span><span class="s2">t </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">encodings</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]):</span>
    <span class="s2">segment1 </span><span class="s3">= (</span><span class="s2">encodings</span><span class="s3">[..., </span><span class="s2">t</span><span class="s3">], [</span><span class="s2">encodings</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s2">t</span><span class="s3">] + </span><span class="s5">10</span><span class="s3">, </span><span class="s2">encodings</span><span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s2">t</span><span class="s3">]])</span>
    <span class="s2">segment2 </span><span class="s3">= (</span><span class="s2">encodings</span><span class="s3">[..., </span><span class="s2">t</span><span class="s3">], </span><span class="s2">np</span><span class="s3">.</span><span class="s2">mean</span><span class="s3">(</span><span class="s2">encodings</span><span class="s3">[..., </span><span class="s2">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">t</span><span class="s3">-</span><span class="s2">window</span><span class="s3">):</span><span class="s2">max</span><span class="s3">(</span><span class="s2">t</span><span class="s3">, </span><span class="s2">window</span><span class="s3">)], </span><span class="s2">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">))</span>
    <span class="s2">phi_t</span><span class="s3">.</span><span class="s2">append</span><span class="s3">(</span><span class="s2">calculate_angle</span><span class="s3">(</span><span class="s2">segment1</span><span class="s3">, </span><span class="s2">segment2</span><span class="s3">))</span>
<span class="s2">phi_t </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">array</span><span class="s3">(</span><span class="s2">phi_t</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2">If we plot these phases, we do obtain nice, constant oscillations... 
</span><span class="s0">#%% 
</span><span class="s2">fig</span><span class="s3">, </span><span class="s2">ax </span><span class="s3">= </span><span class="s2">plt</span><span class="s3">.</span><span class="s2">subplots</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s2">figsize</span><span class="s3">=(</span><span class="s5">18</span><span class="s3">, </span><span class="s5">12</span><span class="s3">))</span>

<span class="s2">ax</span><span class="s3">.</span><span class="s2">plot</span><span class="s3">(</span><span class="s2">phi_t</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_ylabel</span><span class="s3">(</span><span class="s4">'Phase (degrees)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xlabel</span><span class="s3">(</span><span class="s4">'Time (s)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">grid</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>
<span class="s2">T </span><span class="s3">= </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s2">fs</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">), </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">))</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">T </span><span class="s3">+ </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">, </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">'right'</span><span class="s3">].</span><span class="s2">set_visible</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">'top'</span><span class="s3">].</span><span class="s2">set_visible</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">'left'</span><span class="s3">].</span><span class="s2">set_visible</span><span class="s3">(</span><span class="s1">True</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">'bottom'</span><span class="s3">].</span><span class="s2">set_visible</span><span class="s3">(</span><span class="s1">True</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">&quot;left&quot;</span><span class="s3">].</span><span class="s2">set_color</span><span class="s3">(</span><span class="s4">'grey'</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">&quot;bottom&quot;</span><span class="s3">].</span><span class="s2">set_color</span><span class="s3">(</span><span class="s4">'grey'</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">&quot;left&quot;</span><span class="s3">].</span><span class="s2">set_linewidth</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">spines</span><span class="s3">[</span><span class="s4">&quot;bottom&quot;</span><span class="s3">].</span><span class="s2">set_linewidth</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">tick_params</span><span class="s3">(</span><span class="s2">axis</span><span class="s3">=</span><span class="s4">'both'</span><span class="s3">, </span><span class="s2">which</span><span class="s3">=</span><span class="s4">'major'</span><span class="s3">, </span><span class="s2">labelsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2">... that overlay perfectly with the spiking signal! 
</span><span class="s0">#%% 
</span><span class="s2">fig</span><span class="s3">, </span><span class="s2">ax </span><span class="s3">= </span><span class="s2">plt</span><span class="s3">.</span><span class="s2">subplots</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s2">figsize</span><span class="s3">=(</span><span class="s5">18</span><span class="s3">, </span><span class="s5">12</span><span class="s3">))</span>

<span class="s2">spikes_downsampled </span><span class="s3">= </span><span class="s2">spikes_downsample</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">, </span><span class="s2">downsampling_factor</span><span class="s3">, </span><span class="s2">mode</span><span class="s3">=</span><span class="s4">'max'</span><span class="s3">)</span>
<span class="s2">spikes_downsampled </span><span class="s3">= </span><span class="s2">spikes_downsampled</span><span class="s3">[</span><span class="s2">sorting_corr</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s5">600 </span><span class="s3">* </span><span class="s2">fs</span><span class="s3">): </span><span class="s2">int</span><span class="s3">(</span><span class="s5">3600 </span><span class="s3">* </span><span class="s2">fs</span><span class="s3">)]</span>

<span class="s0"># Obtain the phase in radians</span>
<span class="s1">for </span><span class="s2">t </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s2">len</span><span class="s3">(</span><span class="s2">phi_t</span><span class="s3">)):</span>
    <span class="s1">if </span><span class="s2">phi_t</span><span class="s3">[</span><span class="s2">t</span><span class="s3">] &lt; </span><span class="s2">phi_t</span><span class="s3">[</span><span class="s2">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">]:</span>
        <span class="s2">phi_t</span><span class="s3">[</span><span class="s2">t</span><span class="s3">] = </span><span class="s1">None</span>


<span class="s2">ax</span><span class="s3">.</span><span class="s2">plot</span><span class="s3">(</span><span class="s2">phi_t </span><span class="s3">/ </span><span class="s5">180 </span><span class="s3">* </span><span class="s2">len</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">) * </span><span class="s5">5</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">imshow</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">repeat</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s2">cmap</span><span class="s3">=</span><span class="s4">'Greys'</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_ylabel</span><span class="s3">(</span><span class="s4">'Phase (degrees)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xlabel</span><span class="s3">(</span><span class="s4">'Time (s)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">grid</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>

<span class="s2">T </span><span class="s3">= </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s2">fs</span>
<span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">), </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">3</span><span class="s3">))</span>
<span class="s0">#%% md 
</span><span class="s2">So that seems to work, but in the absence of any knowledge of this sorting, would we have been able to uncover these oscillations using SPARKS? 
To figure it out, we compute the correlation of each smoothed spiking sequence with the phase signal, and sort the neurons according to the peak of their correlation.  
</span><span class="s0">#%% 
</span><span class="s1">def </span><span class="s2">sort_with_sparks</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">, </span><span class="s2">phase</span><span class="s3">, </span><span class="s2">maxlag</span><span class="s3">, </span><span class="s2">dt_sf</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Sort neurons based on their correlation factor with the phase signal 
    Args: 
        spikes:  
        phase:  
        maxlag:  
        dt_sf:  
 
    Returns: 
    &quot;&quot;&quot;</span>

    <span class="s2">FR </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">vstack</span><span class="s3">([</span><span class="s2">fire_rate</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">[</span><span class="s2">i</span><span class="s3">], </span><span class="s2">dt_sf</span><span class="s3">) </span><span class="s1">for </span><span class="s2">i </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">len</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">))])</span>
    <span class="s2">corr_vec </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">zeros</span><span class="s3">(</span><span class="s2">spikes</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>

    <span class="s1">for </span><span class="s2">i </span><span class="s1">in </span><span class="s2">range</span><span class="s3">(</span><span class="s2">FR</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]):</span>
        <span class="s2">val </span><span class="s3">= </span><span class="s2">correlate</span><span class="s3">(</span><span class="s2">FR</span><span class="s3">[</span><span class="s2">i</span><span class="s3">], </span><span class="s2">phase</span><span class="s3">, </span><span class="s2">mode</span><span class="s3">=</span><span class="s4">'full'</span><span class="s3">)</span>
        <span class="s2">time </span><span class="s3">= </span><span class="s2">correlation_lags</span><span class="s3">(</span><span class="s2">len</span><span class="s3">(</span><span class="s2">FR</span><span class="s3">[</span><span class="s2">i</span><span class="s3">]), </span><span class="s2">len</span><span class="s3">(</span><span class="s2">phase</span><span class="s3">), </span><span class="s2">mode</span><span class="s3">=</span><span class="s4">'full'</span><span class="s3">)</span>
        <span class="s2">idx </span><span class="s3">= </span><span class="s2">np</span><span class="s3">.</span><span class="s2">argmax</span><span class="s3">(</span><span class="s2">val</span><span class="s3">[</span><span class="s2">np</span><span class="s3">.</span><span class="s2">abs</span><span class="s3">(</span><span class="s2">time</span><span class="s3">) &lt; </span><span class="s2">maxlag</span><span class="s3">])</span>
        <span class="s2">v </span><span class="s3">= </span><span class="s2">val</span><span class="s3">[</span><span class="s2">np</span><span class="s3">.</span><span class="s2">abs</span><span class="s3">(</span><span class="s2">time</span><span class="s3">) &lt; </span><span class="s2">maxlag</span><span class="s3">][</span><span class="s2">idx</span><span class="s3">]</span>
        <span class="s2">t </span><span class="s3">= </span><span class="s2">time</span><span class="s3">[</span><span class="s2">np</span><span class="s3">.</span><span class="s2">abs</span><span class="s3">(</span><span class="s2">time</span><span class="s3">) &lt; </span><span class="s2">maxlag</span><span class="s3">][</span><span class="s2">idx</span><span class="s3">]</span>

        <span class="s1">if </span><span class="s2">t </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">corr_vec</span><span class="s3">[</span><span class="s2">i</span><span class="s3">] = </span><span class="s2">v</span>
        <span class="s1">else</span><span class="s3">:</span>
            <span class="s2">corr_vec</span><span class="s3">[</span><span class="s2">i</span><span class="s3">] = -</span><span class="s2">v</span>
    
    <span class="s1">return </span><span class="s2">np</span><span class="s3">.</span><span class="s2">argsort</span><span class="s3">(</span><span class="s2">corr_vec</span><span class="s3">)</span>

<span class="s2">sorting_sparks </span><span class="s3">= </span><span class="s2">sort_with_sparks</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">[:, </span><span class="s2">int</span><span class="s3">(</span><span class="s5">600 </span><span class="s3">* </span><span class="s2">fs</span><span class="s3">):], </span><span class="s2">phi_t</span><span class="s3">, </span><span class="s2">maxlag</span><span class="s3">, </span><span class="s2">osc_bin_size</span><span class="s3">)</span>
<span class="s0">#%% md 
</span><span class="s2">It turns out this produces an even better sorting than that obtained with the technique proposed in the paper! 
</span><span class="s0">#%% 
</span><span class="s2">fig</span><span class="s3">, </span><span class="s2">axs </span><span class="s3">= </span><span class="s2">plt</span><span class="s3">.</span><span class="s2">subplots</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s2">figsize</span><span class="s3">=(</span><span class="s5">13</span><span class="s3">, </span><span class="s5">11</span><span class="s3">))</span>

<span class="s2">axs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">imshow</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">flip</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">repeat</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">[</span><span class="s2">sorting_sparks</span><span class="s3">], </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s2">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">), </span><span class="s2">cmap</span><span class="s3">=</span><span class="s4">'Greys'</span><span class="s3">)</span>
<span class="s2">axs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">set_title</span><span class="s3">(</span><span class="s4">'Sorted with SPARKS'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">axs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s2">grid</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>

<span class="s2">axs</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">imshow</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">repeat</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s2">cmap</span><span class="s3">=</span><span class="s4">'Greys'</span><span class="s3">)</span>
<span class="s2">axs</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">set_title</span><span class="s3">(</span><span class="s4">'Correlation sorting'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>
<span class="s2">axs</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">grid</span><span class="s3">(</span><span class="s1">False</span><span class="s3">)</span>

<span class="s1">for </span><span class="s2">ax </span><span class="s1">in </span><span class="s2">axs</span><span class="s3">:</span>
    <span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">int</span><span class="s3">(</span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] + </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">), </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
    <span class="s2">ax</span><span class="s3">.</span><span class="s2">set_xticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">T </span><span class="s3">+ </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">5</span><span class="s3">, </span><span class="s2">T </span><span class="s3">/ </span><span class="s5">5</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
    
    <span class="s2">ax</span><span class="s3">.</span><span class="s2">set_yticks</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5 </span><span class="s3">* </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">))</span>
    <span class="s2">ax</span><span class="s3">.</span><span class="s2">set_yticklabels</span><span class="s3">(</span><span class="s2">np</span><span class="s3">.</span><span class="s2">arange</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">, </span><span class="s2">spikes_downsampled</span><span class="s3">.</span><span class="s2">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">5</span><span class="s3">).</span><span class="s2">astype</span><span class="s3">(</span><span class="s2">int</span><span class="s3">), </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
    <span class="s2">ax</span><span class="s3">.</span><span class="s2">set_ylabel</span><span class="s3">(</span><span class="s4">'Neurons'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span>

<span class="s2">axs</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s2">set_xlabel</span><span class="s3">(</span><span class="s4">'Time (s)'</span><span class="s3">, </span><span class="s2">fontsize</span><span class="s3">=</span><span class="s5">25</span><span class="s3">)</span></pre>
</body>
</html>